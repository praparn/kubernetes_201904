Instruction for Workshop 2.7 Kubernetes for Stateful Application:
Note: This instruction will start lab for kubernetes for real workshop:
====================================================
Lab Description:
Machine name		            					Roles:						IP Address: (Private)		IP Address: (Public)			Hostname
Training_DockerZerotoHero_StudentGX_1	   		 	Master						10.0.1.X								X.X.X.X										ip-10-0-1-X.ap-southeast-1.compute.internal
Training_DockerZerotoHero_StudentGX_2       		NodePort					10.0.1.X								X.X.X.X										ip-10-0-1-X.ap-southeast-1.compute.internal
Training_DockerZerotoHero_StudentGX_3   			NodePort					10.0.1.X								X.X.X.X										ip-10-0-1-X.ap-southeast-1.compute.internal
===================================================

===================================================
Part 1: Create Storage Class and Test Provision Disk
===================================================
1. (Master) Create "Storage Class" for AWS and check by command:
kubectl apply -f ~/kubernetes_201904/WorkShop_2.7_Persistent_Storage/aws_sc.yml (In case run via github : kubectl create -f https://raw.githubusercontent.com/praparn/kubernetes_201904/master/WorkShop_2.7_Persistent_Storage/aws_sc.yml)

2. (Master) Check existing "Persistant Volume (PV)" and "Persistent Volume Claim (PVC)" by command:
kubectl describe sc/aws-ebs
kubectl get pv
kubectl get pvc

3. (Master) Test create dynamic provision disk from "Persistent Volume Claim (PVC)" from "Storage Class" by command:
kubectl apply -f ~/kubernetes_201904/WorkShop_2.7_Persistent_Storage/aws_pvc.yml (In case run via github : kubectl create -f https://raw.githubusercontent.com/praparn/kubernetes_201904/master/WorkShop_2.7_Persistent_Storage/aws_pvc.yml)
watch kubectl get pvc         ==> Take around 1 - 2 min
===================================================
Example Result:
ubuntu@ip-10-0-1-229:~$ kubectl get pvc
NAME          STATUS    VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE
aws-ebs-pvc   Pending                                      aws-ebs        4s
ubuntu@ip-10-0-1-229:~$ kubectl get pvc
NAME          STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
aws-ebs-pvc   Bound    pvc-0a14702e-4268-11e9-9e8e-02d2ffaea91a   5Gi        RWO            aws-ebs        18s
===================================================

4. (Master) Check "Persistant Volume (PV)" and "Persistent Volume Claim (PVC)" by command:
kubectl get pv
kubectl get pvc

5. (Master) Check detail of PVC by command:
kubectl describe pvc/aws-ebs-pvc 

===================================================
Part 2: Integrate with Persistency Volume (PV),  and Persistency Volume Claim (PVC)
===================================================

1. (Master) Download source file "mainlite.py" to storage by command:
kubectl create -f ~/kubernetes_201904/WorkShop_2.7_Persistent_Storage/aws_pvc_prepare.yml (In case run via github : kubectl create -f https://raw.githubusercontent.com/praparn/kubernetes_201904/master/WorkShop_2.7_Persistent_Storage/aws_pvc_prepare.yml)
kubectl get pods    ==> Record pods name
kubectl exec <pods name> cp /usr/src/app/mainlite.py /source/mainlite.py
kubectl delete -f ~/kubernetes_201904/WorkShop_2.7_Persistent_Storage/aws_pvc_prepare.yml (In case run via github : kubectl delete -f https://raw.githubusercontent.com/praparn/kubernetes_201904/master/WorkShop_2.7_Persistent_Storage/aws_pvc_prepare.yml)

2. (Master) Create PVC and Deployment by command: change ip address of NFS to <Private IP Address of master>:
kubectl create -f ~/kubernetes_201904/WorkShop_2.7_Persistent_Storage/aws_webtest_deploy.yml (In case run via github : kubectl create -f https://raw.githubusercontent.com/praparn/kubernetes_201904/master/WorkShop_2.7_Persistent_Storage/aws_webtest_deploy.yml)

3. (Master) Check status of PV, PVC and Deployment by command:
kubectl get pv
kubectl get pvc
kubectl get deployment
kubectl get pods

5. (Master) Create PVC for Claim Storage by command: 
kubectl create -f nfs_pvc.yml   (In case run via github : kubectl create -f https://raw.githubusercontent.com/praparn/kubernetes_201904/master/WorkShop_2.7_Persistent_Storage/nfs_pvc.yml)

6. (Master) Check status of PVC by command:
kubectl get pvc
kubectl describe pvc/nfs-share-pvc

7. (Master) Create Deployment and Persistency Volume Claim (PVC) by command:
kubectl create -f nfs_webtest_deploy.yml    (In case run via github : kubectl create -f https://raw.githubusercontent.com/praparn/kubernetes_201904/master/WorkShop_2.7_Persistent_Storage/nfs_webtest_deploy.yml)
kubectl create -f nfs_webtest_svc.yml   (In case run via github : kubectl create -f https://raw.githubusercontent.com/praparn/kubernetes_201904/master/WorkShop_2.7_Persistent_Storage/nfs_webtest_svc.yml)
kubectl get deployment
kubectl get svc
kubectl get pods -o wide

8. (Master) Access to pods by kubectl or docker exec and check mount volume by command:
kubectl exec -it <pods name> sh
ls

9. (Master:inside pods) Check volume from NFS inside container and test create file by command:
df -kh ==> check /usr/src/app 
exit

10. (Master) Access to all pods for check/create file by command:
    kubectl get pods -o wide
    
    kubectl exec -it <pods name> sh (Pods: 1)
    touch /usr/src/app/test-Pods1
    ls -lh /usr/src/app
    exit

    kubectl exec -it <pods name> sh (Pods: 2)
    touch /usr/src/app/test-Pods2
    ls -lh /usr/src/app
    exit

    kubectl exec -it <pods name> sh (Pods: 3)
    touch /usr/src/app/test-Pods3
    ls -lh /usr/src/app
    rm /usr/src/app/test-Pods*
    exit

11. (Master) Clean Up file and deployment by command:
    kubectl delete -f aws_webtest_deploy.yml    (In case run via github : kubectl delete -f https://raw.githubusercontent.com/praparn/kubernetes_201904/master/WorkShop_2.7_Persistent_Storage/aws_webtest_deploy.yml)
    kubectl delete -f aws_webtest_svc.yml   (In case run via github : kubectl delete -f https://raw.githubusercontent.com/praparn/kubernetes_201904/master/WorkShop_2.7_Persistent_Storage/aws_webtest_svc.yml)
   